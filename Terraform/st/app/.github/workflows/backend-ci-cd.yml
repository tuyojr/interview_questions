name: Backend CI/CD

on:
  push:
    branches:
      - main
      # - develop
    paths:
      - 'app/backend/**'
      - 'app/.github/workflows/backend-ci-cd.yml'
  pull_request:
    branches:
      - main
      # - develop
    paths:
      - 'app/backend/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'nonprod'
        type: choice
        options:
          - nonprod
          - prod

env:
  GO_VERSION: '1.25'
  AWS_REGION: 'us-east-1'
  DOCKER_REGISTRY: 'docker.io'  # Change to your ECR or Docker Hub

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app/backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: app/backend/go.sum

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('app/backend/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Run go vet
        run: go vet ./...

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: v2.6
          working-directory: app/backend
          args: --timeout=10m

      - name: Run unit tests
        run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: app/backend/coverage.out
          flags: backend
          name: backend-coverage
        continue-on-error: true

      - name: Run integration tests
        run: |
          if [ -d "tests/integration" ]; then
            go test -v ./tests/integration/... -tags=integration
          else
            echo "No integration tests found"
          fi

      - name: Test summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # Backend Test Summary

          ## Status: âœ… Tests Passed

          ### Test Details
          - **Go Version**: ${{ env.GO_VERSION }}
          - **Branch**: ${{ github.ref_name }}
          - **Commit**: ${{ github.sha }}
          - **Triggered by**: @${{ github.actor }}
          EOF

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: test
    defaults:
      run:
        working-directory: app/backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run Gosec security scanner
        uses: securego/gosec@master
        with:
          args: '-fmt sarif -out gosec-results.sarif ./...'

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'fs'
          scan-ref: 'app/backend'
          format: 'sarif'
          output: 'trivy-results.sarif'
          ignore-unfixed: true

      # - name: Upload Gosec results
      #   uses: github/codeql-action/upload-sarif@v3
      #   with:
      #     sarif_file: gosec-results.sarif
      #   continue-on-error: true

      # - name: Upload Trivy results
      #   uses: github/codeql-action/upload-sarif@v3
      #   with:
      #     sarif_file: trivy-results.sarif
      #   continue-on-error: true

  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: [test, security-scan]
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}
    defaults:
      run:
        working-directory: app/backend

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/muchtodo-backend
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: app/backend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Scan Docker image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.meta.outputs.tags }}
          format: 'sarif'
          output: 'trivy-image-results.sarif'
        continue-on-error: true

      # - name: Upload Trivy scan results
      #   uses: github/codeql-action/upload-sarif@v3
      #   with:
      #     sarif_file: trivy-image-results.sarif
      #   continue-on-error: true

      - name: Build summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # Backend Docker Build Summary

          ## Status: âœ… Build Successful

          ### Image Details
          - **Tags**: ${{ steps.meta.outputs.tags }}
          - **Digest**: ${{ steps.build.outputs.digest }}

          ### Build Info
          - **Commit**: ${{ github.sha }}
          - **Branch**: ${{ github.ref_name }}
          - **Built by**: @${{ github.actor }}
          EOF

  deploy-nonprod:
    name: Deploy to Non-Prod
    runs-on: ubuntu-latest
    needs: build-and-push
    if: |
      (github.ref == 'refs/heads/develop' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'nonprod')
    environment:
      name: nonprod
      url: ${{ steps.get-alb.outputs.alb_url }}
    defaults:
      run:
        working-directory: app

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get infrastructure outputs
        id: get-alb
        run: |
          cd ../infra/terraform
          ALB_URL=$(terraform output -raw alb_url 2>/dev/null || echo "")
          ASG_NAME=$(terraform output -raw asg_name 2>/dev/null || echo "")

          echo "alb_url=${ALB_URL}" >> $GITHUB_OUTPUT
          echo "asg_name=${ASG_NAME}" >> $GITHUB_OUTPUT

      - name: Deploy to EC2
        run: |
          chmod +x scripts/deploy-backend.sh
          ./scripts/deploy-backend.sh nonprod ${{ needs.build-and-push.outputs.image_tag }}

      - name: Run health check
        run: |
          chmod +x scripts/health-check.sh
          ./scripts/health-check.sh ${{ steps.get-alb.outputs.alb_url }}

      - name: Run smoke tests
        run: |
          # Basic smoke tests
          curl -f ${{ steps.get-alb.outputs.alb_url }}/health || exit 1
          echo "âœ… Health check passed"

      - name: Deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # Backend Deployment to Non-Prod

          ## Status: âœ… Deployed Successfully

          ### Deployment Details
          - **Environment**: nonprod
          - **ALB URL**: ${{ steps.get-alb.outputs.alb_url }}
          - **ASG Name**: ${{ steps.get-alb.outputs.asg_name }}
          - **Image**: ${{ needs.build-and-push.outputs.image_tag }}
          - **Deployed by**: @${{ github.actor }}
          - **Commit**: ${{ github.sha }}

          ### Health Status
          - âœ… Health checks passed
          - ðŸ”„ Rolling update completed
          - â±ï¸ Post-deployment monitoring completed
          EOF

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, initiating rollback..."
          chmod +x scripts/rollback.sh
          ./scripts/rollback.sh prod backend
