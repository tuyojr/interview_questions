name: Sync Secrets to AWS Secrets Manager

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to sync secrets to'
        required: true
        type: choice
        options:
          - nonprod
          - prod
  workflow_call:
    inputs:
      environment:
        description: 'Environment to sync secrets to'
        required: true
        type: string

env:
  AWS_REGION: 'us-east-1'

jobs:
  sync-secrets:
    name: Sync Secrets to AWS
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Sync JWT Secret
        run: |
          echo "Syncing JWT secret to muchtodo-${{ inputs.environment }}-jwt-secret"
          aws secretsmanager put-secret-value \
            --secret-id muchtodo-${{ inputs.environment }}-jwt-secret \
            --secret-string "{\"jwt_secret_key\":\"${{ secrets.JWT_SECRET_KEY }}\"}" \
            --region ${{ env.AWS_REGION }}
          echo "✅ JWT secret synced successfully"

      - name: Sync MongoDB Credentials
        run: |
          echo "Syncing MongoDB credentials to muchtodo-${{ inputs.environment }}-mongodb-credentials"

          # Build MongoDB credentials JSON
          MONGO_URI="${{ secrets.MONGO_URI }}"
          MONGO_USERNAME="${{ secrets.MONGO_USERNAME }}"
          MONGO_PASSWORD="${{ secrets.MONGO_PASSWORD }}"

          # Create JSON payload
          cat > /tmp/mongodb-secret.json <<EOF
          {
            "mongo_uri": "${MONGO_URI}",
            "mongo_initdb_root_username": "${MONGO_USERNAME}",
            "mongo_initdb_root_password": "${MONGO_PASSWORD}",
            "db_name": "much_todo_db"
          }
          EOF

          aws secretsmanager put-secret-value \
            --secret-id muchtodo-${{ inputs.environment }}-mongodb-credentials \
            --secret-string file:///tmp/mongodb-secret.json \
            --region ${{ env.AWS_REGION }}

          # Clean up temp file
          rm -f /tmp/mongodb-secret.json
          echo "✅ MongoDB credentials synced successfully"

      - name: Sync Redis Credentials
        run: |
          echo "Syncing Redis credentials to muchtodo-${{ inputs.environment }}-redis-credentials"
          aws secretsmanager put-secret-value \
            --secret-id muchtodo-${{ inputs.environment }}-redis-credentials \
            --secret-string "{\"redis_password\":\"${{ secrets.REDIS_PASSWORD }}\"}" \
            --region ${{ env.AWS_REGION }}
          echo "✅ Redis credentials synced successfully"

      - name: Sync Mongo Express Credentials
        run: |
          echo "Syncing Mongo Express credentials to muchtodo-${{ inputs.environment }}-mongo-express-credentials"
          aws secretsmanager put-secret-value \
            --secret-id muchtodo-${{ inputs.environment }}-mongo-express-credentials \
            --secret-string "{\"me_config_basicauth_username\":\"${{ secrets.ME_CONFIG_BASICAUTH_USERNAME }}\",\"me_config_basicauth_password\":\"${{ secrets.ME_CONFIG_BASICAUTH_PASSWORD }}\"}" \
            --region ${{ env.AWS_REGION }}
          echo "✅ Mongo Express credentials synced successfully"

      - name: Verify Secrets
        run: |
          echo "Verifying all secrets were updated..."

          # Check JWT secret
          JWT_LAST_UPDATED=$(aws secretsmanager describe-secret \
            --secret-id muchtodo-${{ inputs.environment }}-jwt-secret \
            --region ${{ env.AWS_REGION }} \
            --query 'LastChangedDate' \
            --output text)
          echo "JWT Secret last updated: ${JWT_LAST_UPDATED}"

          # Check MongoDB credentials
          MONGODB_LAST_UPDATED=$(aws secretsmanager describe-secret \
            --secret-id muchtodo-${{ inputs.environment }}-mongodb-credentials \
            --region ${{ env.AWS_REGION }} \
            --query 'LastChangedDate' \
            --output text)
          echo "MongoDB Credentials last updated: ${MONGODB_LAST_UPDATED}"

          # Check Redis credentials
          REDIS_LAST_UPDATED=$(aws secretsmanager describe-secret \
            --secret-id muchtodo-${{ inputs.environment }}-redis-credentials \
            --region ${{ env.AWS_REGION }} \
            --query 'LastChangedDate' \
            --output text)
          echo "Redis Credentials last updated: ${REDIS_LAST_UPDATED}"

          # Check Mongo Express credentials
          ME_LAST_UPDATED=$(aws secretsmanager describe-secret \
            --secret-id muchtodo-${{ inputs.environment }}-mongo-express-credentials \
            --region ${{ env.AWS_REGION }} \
            --query 'LastChangedDate' \
            --output text)
          echo "Mongo Express Credentials last updated: ${ME_LAST_UPDATED}"

          echo "✅ All secrets verified successfully"

      - name: Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # Secrets Sync Summary

          ## Status: ✅ Secrets Synced Successfully

          ### Environment: ${{ inputs.environment }}

          ### Secrets Updated:
          - ✅ JWT Secret: \`muchtodo-${{ inputs.environment }}-jwt-secret\`
          - ✅ MongoDB Credentials: \`muchtodo-${{ inputs.environment }}-mongodb-credentials\`
          - ✅ Redis Credentials: \`muchtodo-${{ inputs.environment }}-redis-credentials\`
          - ✅ Mongo Express Credentials: \`muchtodo-${{ inputs.environment }}-mongo-express-credentials\`

          ### Next Steps:
          - Secrets are now available for EC2 instances to fetch
          - Deploy or restart the backend application to use updated secrets
          - Verify application can connect to MongoDB and Redis

          **Note:** Secret values are never logged or displayed for security.
          EOF
